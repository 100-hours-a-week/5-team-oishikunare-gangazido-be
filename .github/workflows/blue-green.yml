on:
  push:
    branches:
      - feature/map

name: ğŸš€ Blue-Green Deployment (Stable)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Ensure JAVA_HOME is set correctly
        run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

      - name: Debug JAVA_HOME
        run: echo $JAVA_HOME  # í˜„ì¬ JAVA_HOME ê²½ë¡œ ì¶œë ¥ (ë””ë²„ê¹…ìš©)

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          mask-password: true

      - name: Build Spring Boot Application
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar

      - name: Ensure JAR File Exists
        run: |
          ls -lh build/libs/
          if [ ! -f build/libs/*.jar ]; then
            echo "ğŸš¨ JAR íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”!"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Active Environment
        id: active_env
        run: |
          echo "ğŸ” í˜„ì¬ íŠ¸ë˜í”½ì„ ë°›ê³  ìˆëŠ” Target Groupì„ í™•ì¸ ì¤‘..."

          CURRENT_ACTIVE_TARGET_GROUP=$(aws elbv2 describe-rules \
          --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
          --region ap-northeast-2 \
          --query 'Rules[*].Actions[0].ForwardConfig.TargetGroups[*]' \
          --output json | \
          grep -B1 '"Weight": 1' | grep 'TargetGroupArn' | head -n1 | \
          sed 's/.*"TargetGroupArn": "\(.*\)",/\1/')

          echo "í˜„ì¬ í™œì„±í™”ëœ Target Group ARN: $CURRENT_ACTIVE_TARGET_GROUP"

          if [[ "$CURRENT_ACTIVE_TARGET_GROUP" == "${{ secrets.BLUE_TARGET_GROUP_ARN }}" ]]; then
          echo "âœ… BLUEê°€ í™œì„±í™”ë¨, GREENì— ë°°í¬"
          echo "DEPLOY_ENV=GREEN" >> $GITHUB_ENV
          echo "NEW_ASG=gangazido-prod-green" >> $GITHUB_ENV
          echo "NEW_TARGET_GROUP=${{ secrets.GREEN_TARGET_GROUP_ARN }}" >> $GITHUB_ENV
          echo "OLD_ASG=gangazido-prod-blue" >> $GITHUB_ENV
          elif [[ "$CURRENT_ACTIVE_TARGET_GROUP" == "${{ secrets.GREEN_TARGET_GROUP_ARN }}" ]]; then
          echo "âœ… GREENì´ í™œì„±í™”ë¨, BLUEì— ë°°í¬"
          echo "DEPLOY_ENV=BLUE" >> $GITHUB_ENV
          echo "NEW_ASG=gangazido-prod-blue" >> $GITHUB_ENV
          echo "NEW_TARGET_GROUP=${{ secrets.BLUE_TARGET_GROUP_ARN }}" >> $GITHUB_ENV
          echo "OLD_ASG=gangazido-prod-green" >> $GITHUB_ENV
          else
          echo "ğŸš¨ í™œì„±í™”ëœ Target Groupì„ íŒë³„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
          fi

      - name: Debug Deployment Variables
        run: |
          echo "ğŸš€ ë°°í¬ ëŒ€ìƒ ASG: $NEW_ASG"
          echo "ğŸ¯ ìƒˆë¡œìš´ Target Group: $NEW_TARGET_GROUP"
          echo "ğŸ›‘ ê¸°ì¡´ ìš´ì˜ ASG: $OLD_ASG"
          echo "ğŸ“Œ ë°°í¬í•  ì´ë¯¸ì§€ íƒœê·¸: $DEPLOY_ENV"

      # 1. Green í™˜ê²½ ìŠ¤ì¼€ì¼ ì—… ë° í—¬ìŠ¤ì²´í¬ ì¤€ë¹„
      - name: Scale Up Temporary (Green) Auto Scaling Group (${{ env.NEW_ASG }})
        run: |
          aws autoscaling update-auto-scaling-group \
          --auto-scaling-group-name ${{ env.NEW_ASG }} \
          --desired-capacity 4 --min-size 2 --max-size 5

      - name: Start Green ASG Instance Refresh
        run: |
          STATUS=$(aws autoscaling describe-instance-refreshes --auto-scaling-group-name $NEW_ASG \
          --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "None")

          if [[ "$STATUS" == "InProgress" ]]; then
            echo "ğŸš¨ í˜„ì¬ ASG($NEW_ASG)ì˜ ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œê°€ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ëŒ€ê¸°í•©ë‹ˆë‹¤."
            exit 0
          fi

          echo "ğŸ”„ Green ASG($NEW_ASG) ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘"
          aws autoscaling start-instance-refresh --auto-scaling-group-name $NEW_ASG

      - name: Wait Until Green ASG is Healthy
        run: |
          MAX_WAIT=720  # ìµœëŒ€ 12ë¶„
          INTERVAL=10
          ELAPSED=0

          echo "â³ Green ASG($NEW_ASG)ì˜ í—¬ìŠ¤ì²´í¬ ìƒíƒœë¥¼ í™•ì¸ ì¤‘..."

          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $NEW_ASG \
              --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "None")

            echo "í˜„ì¬ ìƒíƒœ: $STATUS"

            if [[ "$STATUS" == "Successful" ]]; then
              echo "âœ… Green ASG ì¸ìŠ¤í„´ìŠ¤ê°€ ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "ğŸš¨ ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨: ìƒíƒœ $STATUS"
              exit 1
            fi

            if [[ "$ELAPSED" -ge "$MAX_WAIT" ]]; then
              echo "ğŸš¨ íƒ€ì„ì•„ì›ƒ: $MAX_WAITì´ˆ ì•ˆì— í—¬ìŠ¤ì²´í¬ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

      # 2. ALBë¥¼ Greenìœ¼ë¡œ ì „í™˜
      - name: Gradually Shift Traffic to New Environment
        run: |
          echo "ğŸ” í˜„ì¬ íŠ¸ë˜í”½ì„ ë°›ê³  ìˆëŠ” Target Groupì„ í™•ì¸ ì¤‘..."

          # í˜„ì¬ íŠ¸ë˜í”½ì„ ë°›ê³  ìˆëŠ” Target Groupì„ ê°€ì ¸ì˜¤ëŠ” AWS CLI ì‹¤í–‰ ê²°ê³¼ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥
          RAW_AWS_RESPONSE=$(aws elbv2 describe-rules \
            --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --query 'Rules[?Conditions[?Field==`host-header`]].Actions[0].ForwardConfig.TargetGroups' \
            --output json)

          echo "ğŸ” [DEBUG] AWS CLI ì‘ë‹µ(JSON):"
          echo "$RAW_AWS_RESPONSE"

          # Weight ê°’ì´ 1ì¸ Target Group ARN ê°€ì ¸ì˜¤ê¸°
          CURRENT_ACTIVE_TARGET_GROUP=$(echo "$RAW_AWS_RESPONSE" | jq -r '[.[][] | select(.Weight == 1)] | .[0].TargetGroupArn')

          echo "ğŸ¯ í˜„ì¬ í™œì„±í™”ëœ Target Group ARN: $CURRENT_ACTIVE_TARGET_GROUP"
          echo "ğŸ¯ ìƒˆë¡œìš´ Target Group ARN: $NEW_TARGET_GROUP"

          # ê°’ì´ ë¹„ì–´ ìˆëŠ” ê²½ìš° ì˜¤ë¥˜ ë°œìƒ
          if [[ -z "$CURRENT_ACTIVE_TARGET_GROUP" || -z "$NEW_TARGET_GROUP" ]]; then
            echo "ğŸš¨ ì˜¤ë¥˜: CURRENT_ACTIVE_TARGET_GROUP ë˜ëŠ” NEW_TARGET_GROUP ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          # ì´ë¯¸ NEW_TARGET_GROUPì´ ìš´ì˜ ì¤‘ì¸ ê²½ìš° íŠ¸ë˜í”½ ë³€ê²½ ê±´ë„ˆëœ€
          if [[ "$CURRENT_ACTIVE_TARGET_GROUP" == "$NEW_TARGET_GROUP" ]]; then
            echo "âš ï¸ ìƒˆë¡œìš´ Target Groupì´ ì´ë¯¸ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤. íŠ¸ë˜í”½ ë³€ê²½ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          else
            echo "ğŸ”„ ALB íŠ¸ë˜í”½ì„ ì ˆë°˜ì”© ë‚˜ëˆ„ì–´ ìƒˆ í™˜ê²½ìœ¼ë¡œ ì´ë™..."
            aws elbv2 modify-listener --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
              --default-actions '[{"Type": "forward", "ForwardConfig": {"TargetGroups": [
                {"TargetGroupArn": "'$CURRENT_ACTIVE_TARGET_GROUP'", "Weight": 50},
                {"TargetGroupArn": "'$NEW_TARGET_GROUP'", "Weight": 50}
              ]}}]' || { echo "ğŸš¨ [ERROR] íŠ¸ë˜í”½ ë³€ê²½ ì‹¤íŒ¨: modify-listener ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"; exit 1; }

            echo "â³ 30ì´ˆ ëŒ€ê¸° í›„ íŠ¸ë˜í”½ í™•ì¸..."
            sleep 30
          fi

      - name: Fully Shift Traffic to New Environment
        run: |
          echo "ğŸ”„ ALB íŠ¸ë˜í”½ì„ ì™„ì „íˆ ìƒˆë¡œìš´ í™˜ê²½($DEPLOY_ENV)ìœ¼ë¡œ ì „í™˜"

          # ìµœì‹  íŠ¸ë˜í”½ ì •ë³´ë¥¼ ê°€ì ¸ì™€ JSON í˜•ì‹ìœ¼ë¡œ í™•ì¸
          RAW_AWS_RESPONSE=$(aws elbv2 describe-rules \
          --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
          --query 'Rules[?Conditions[?Field==`host-header`]].Actions[0].ForwardConfig.TargetGroups' \
          --output json)

          echo "ğŸ” [DEBUG] AWS CLI ì‘ë‹µ(JSON):"
          echo "$RAW_AWS_RESPONSE"

          # Weight == 1ì¸ Target Group ARN íŒŒì‹±
          CURRENT_ACTIVE_TARGET_GROUP=$(echo "$RAW_AWS_RESPONSE" | grep -B1 '"Weight": 1' | grep 'TargetGroupArn' | head -n 1 | awk -F '"' '{print $4}')

          echo "ğŸ¯ í˜„ì¬ í™œì„±í™”ëœ Target Group ARN: $CURRENT_ACTIVE_TARGET_GROUP"

          # ê°’ì´ ë¹„ì–´ ìˆëŠ” ê²½ìš° ì˜¤ë¥˜ ë°œìƒ
          if [[ -z "$CURRENT_ACTIVE_TARGET_GROUP" ]]; then
          echo "ğŸš¨ ì˜¤ë¥˜: CURRENT_ACTIVE_TARGET_GROUPì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. íŠ¸ë˜í”½ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 1
          fi

          # ì´ë¯¸ 100% íŠ¸ë˜í”½ ë°›ê³  ìˆë‹¤ë©´ ë³€ê²½ X
          if [[ "$CURRENT_ACTIVE_TARGET_GROUP" == "$NEW_TARGET_GROUP" ]]; then
          echo "âš ï¸ ì´ë¯¸ $NEW_TARGET_GROUPì´ 100% íŠ¸ë˜í”½ì„ ë°›ê³  ìˆìŠµë‹ˆë‹¤. ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          else
          echo "ğŸš€ ALB íŠ¸ë˜í”½ì„ ì™„ì „íˆ $NEW_TARGET_GROUPìœ¼ë¡œ ì´ë™ ì¤‘..."
          aws elbv2 modify-listener --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
          --default-actions '[{"Type": "forward", "ForwardConfig": {"TargetGroups": [
            {"TargetGroupArn": "'$NEW_TARGET_GROUP'", "Weight": 100}
          ]}}]' || { echo "ğŸš¨ [ERROR] ìµœì¢… íŠ¸ë˜í”½ ë³€ê²½ ì‹¤íŒ¨"; exit 1; }

          echo "âœ… íŠ¸ë˜í”½ì´ ì™„ì „íˆ ìƒˆë¡œìš´ í™˜ê²½($DEPLOY_ENV)ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤."
          fi

#      # 3. Blue ASG ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëª¨ë‘ ì œê±° (íŠ¸ë˜í”½ ì°¨ë‹¨)
#      - name: Scale Down Current (Blue) ASG (${{ env.OLD_ASG }})
#        run: |
#          echo "ğŸ§¹ Blue ASG($OLD_ASG) ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì¡°ì • ì¤‘..."
#          aws autoscaling update-auto-scaling-group \
#            --auto-scaling-group-name ${{ env.OLD_ASG }} \
#            --desired-capacity 0 --min-size 0 --max-size 5
      #ì§€ìš´ë‹¤?

      # 4. Blue ASGì— ìƒˆë¡œìš´ ì½”ë“œ ë°°í¬
      - name: Build and Push Docker Image to Blue
        env:
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
          ECR_REPOSITORY: gangazido-backend
        run: |
          IMAGE_TAG=$(echo "${DEPLOY_ENV}" | tr '[:upper:]' '[:lower:]')

          echo "ğŸ³ Building Docker image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          if [[ -z "$IMAGE_TAG" ]]; then
            echo "ğŸš¨ IMAGE_TAG ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Wait Until Blue ASG is Healthy
        run: |
          MAX_WAIT=360
          INTERVAL=10
          ELAPSED=0
          echo "â³ Blue ASG($OLD_ASG)ì˜ í—¬ìŠ¤ì²´í¬ ìƒíƒœë¥¼ í™•ì¸ ì¤‘..."

          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $OLD_ASG \
              --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "None")

            if [[ "$STATUS" == "Successful" ]]; then
              echo "âœ… Blue ASG ì¸ìŠ¤í„´ìŠ¤ê°€ ëª¨ë‘ ì •ìƒì…ë‹ˆë‹¤!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "ğŸš¨ ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨"
              exit 1
            fi
            if [[ "$ELAPSED" -ge "$MAX_WAIT" ]]; then
              echo "ğŸš¨ í—¬ìŠ¤ì²´í¬ íƒ€ì„ì•„ì›ƒ!"
              exit 1
            fi
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

      # 4. íŠ¸ë˜í”½ì„ ë‹¤ì‹œ Blueë¡œ ì „í™˜
      - name: Shift Traffic Back to Blue
        run: |
          echo "ğŸ”„ ë‹¤ì‹œ íŠ¸ë˜í”½ì„ BLUE($OLD_ASG)ë¡œ ì „í™˜ ì¤‘..."
          aws elbv2 modify-listener --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --default-actions '[{"Type": "forward", "ForwardConfig": {"TargetGroups": [
              {"TargetGroupArn": "'${{ secrets.BLUE_TARGET_GROUP_ARN }}'", "Weight": 100}
            ]}}]'
          echo "âœ… íŠ¸ë˜í”½ì´ BLUE í™˜ê²½ìœ¼ë¡œ ë³µê·€ ì™„ë£Œ"

      - name: Refresh Blue ASG to Apply New Image
        run: |
          aws autoscaling start-instance-refresh --auto-scaling-group-name $OLD_ASG

      # 6. Green í™˜ê²½ì€ ë‹¤ì‹œ ì¶•ì†Œ
      - name: Scale Down Green ASG
        run: |
          echo "âœ… Green ASG($NEW_ASG)ë¥¼ ì¶•ì†Œí•©ë‹ˆë‹¤."
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ env.NEW_ASG }} \
            --desired-capacity 2 --min-size 2 --max-size 5

#ì°ë§‰ì´ë‹¤ ì§„ì§œë¡œ
