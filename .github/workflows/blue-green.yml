on:
  push:
    branches:
      - feature/map

name: ğŸš€ Blue-Green Deployment (Stable)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: Ensure JAVA_HOME is set correctly
        run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

      - name: Debug JAVA_HOME
        run: echo $JAVA_HOME  # í˜„ì¬ JAVA_HOME ê²½ë¡œ ì¶œë ¥ (ë””ë²„ê¹…ìš©)

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          mask-password: true

      - name: Build Spring Boot Application
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar

      - name: Ensure JAR File Exists
        run: |
          ls -lh build/libs/
          if [ ! -f build/libs/*.jar ]; then
            echo "ğŸš¨ JAR íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¹Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”!"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine Active Environment
        id: active_env
        run: |
          CURRENT_TARGET_GROUP=$(aws elbv2 describe-listeners --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
          --query 'Listeners[0].DefaultActions[0].TargetGroupArn' --output text)

          echo "í˜„ì¬ í™œì„±í™”ëœ Target Group: $CURRENT_TARGET_GROUP"

          if [[ "$CURRENT_TARGET_GROUP" == "${{ secrets.BLUE_TARGET_GROUP_ARN }}" ]]; then
            echo "BLUEê°€ í™œì„±í™”ë¨, GREENì— ë°°í¬"
            echo "DEPLOY_ENV=GREEN" >> $GITHUB_ENV
            echo "NEW_ASG=gangazido-prod-green" >> $GITHUB_ENV
            echo "NEW_TARGET_GROUP=${{ secrets.GREEN_TARGET_GROUP_ARN }}" >> $GITHUB_ENV
            echo "OLD_ASG=gangazido-prod-blue" >> $GITHUB_ENV
          else
            echo "GREENì´ í™œì„±í™”ë¨, BLUEì— ë°°í¬"
            echo "DEPLOY_ENV=BLUE" >> $GITHUB_ENV
            echo "NEW_ASG=gangazido-prod-blue" >> $GITHUB_ENV
            echo "NEW_TARGET_GROUP=${{ secrets.BLUE_TARGET_GROUP_ARN }}" >> $GITHUB_ENV
            echo "OLD_ASG=gangazido-prod-green" >> $GITHUB_ENV
          fi

      - name: Debug Deployment Variables
        run: |
          echo "ğŸš€ ë°°í¬ ëŒ€ìƒ ASG: $NEW_ASG"
          echo "ğŸ¯ ìƒˆë¡œìš´ Target Group: $NEW_TARGET_GROUP"
          echo "ğŸ›‘ ê¸°ì¡´ ìš´ì˜ ASG: $OLD_ASG"

      - name: Build and Push Docker Image
        env:
          ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
          ECR_REPOSITORY: gangazido-backend
        run: |
          IMAGE_TAG=$(echo "${DEPLOY_ENV}" | tr '[:upper:]' '[:lower:]')

          echo "ğŸ³ Building Docker image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          if [[ -z "$IMAGE_TAG" ]]; then
            echo "ğŸš¨ IMAGE_TAG ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!!!"
            exit 1
          fi

          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Start New ASG Instance Refresh
        run: |
          STATUS=$(aws autoscaling describe-instance-refreshes --auto-scaling-group-name $NEW_ASG \
          --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "None")

          if [[ "$STATUS" == "InProgress" ]]; then
            echo "ğŸš¨ í˜„ì¬ ASG($NEW_ASG)ì˜ ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œê°€ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ëŒ€ê¸°í•©ë‹ˆë‹¤."
            exit 0
          fi

          echo "ğŸ”„ ìƒˆë¡œìš´ ASG($NEW_ASG) ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘"
          aws autoscaling start-instance-refresh --auto-scaling-group-name $NEW_ASG

      - name: Wait for New ASG to be Healthy
        run: |
          echo "â³ ìƒˆë¡œìš´ ASGê°€ í—¬ìŠ¤ì²´í¬ë¥¼ í†µê³¼í•  ë•Œê¹Œì§€ ëŒ€ê¸°..."
          sleep 60

      - name: Verify New ASG Instances
        run: |
          STATUS=$(aws autoscaling describe-instance-refreshes --auto-scaling-group-name $NEW_ASG \
          --query 'InstanceRefreshes[0].Status' --output text 2>/dev/null || echo "None")

          if [[ "$STATUS" != "Successful" ]]; then
            echo "ğŸš¨ ìƒˆë¡œìš´ ASG($NEW_ASG)ì˜ í—¬ìŠ¤ì²´í¬ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: Switch ALB to New Target Group
        run: |
          echo "ğŸ”„ ALBë¥¼ ìƒˆë¡œìš´ Target Group($NEW_TARGET_GROUP)ìœ¼ë¡œ ë³€ê²½ ì¤‘..."
          aws elbv2 modify-listener --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=$NEW_TARGET_GROUP

      - name: Verify New ALB Health
        run: |
          ALB_URL="http://gangazido-alb-2142561859.ap-northeast-2.elb.amazonaws.com"

          for i in {1..10}; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" $ALB_URL)

            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… ë°°í¬ ì„±ê³µ: HTTP 200"
              exit 0
            fi

            echo "â³ ALB í—¬ìŠ¤ ì²´í¬ ì¤‘... ($i/10)"
            sleep 3
          done

          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨: ì •ìƒ ì‘ë‹µ ì—†ìŒ"
          exit 1

      - name: Cleanup Old Auto Scaling Group
        run: |
          echo "ğŸ›‘ ê¸°ì¡´ ASG($OLD_ASG) ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘"
          aws autoscaling start-instance-refresh --auto-scaling-group-name $OLD_ASG
